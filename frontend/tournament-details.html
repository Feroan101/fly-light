<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tournament Details</title>
  <style>
    :root {
      --bg-dark: #050b1a;
      --bg-panel: #0b1224;
      --bg-card: #131a33;
      --accent: #3aa9ff;
      --accent-soft: rgba(58, 169, 255, 0.2);
      --accent-strong: #1dd1a1;
      --text: #f5f7ff;
      --muted: #9ba4ce;
      --danger: #ff6b6b;
      --success: #10B981;
      --warning: #FF6B35;
      --border: #242b4a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #19244a 0, #050816 50%, #02030a 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .navbar {
      background: rgba(5, 11, 26, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar a {
      color: var(--text);
      text-decoration: none;
      margin-left: 20px;
      font-size: 14px;
      transition: color 0.3s;
    }

    .navbar a:hover {
      color: var(--accent);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .header {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 40px;
    }

    .poster-section {
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    .poster-img {
      width: 100%;
      height: 300px;
      background: rgba(58, 169, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
    }

    .poster-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tournament-info {
      padding: 20px;
    }

    .tournament-info h1 {
      margin-bottom: 15px;
      font-size: 28px;
    }

    .tournament-info p {
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 14px;
    }

    .tournament-info strong {
      color: var(--text);
    }

    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 15px;
    }

    .status-upcoming {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-ongoing {
      background: rgba(255, 107, 53, 0.2);
      color: var(--warning);
      border: 1px solid rgba(255, 107, 53, 0.3);
    }

    .status-completed {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid rgba(107, 114, 128, 0.3);
    }

    .tournament-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .meta-item {
      background: rgba(255, 255, 255, 0.04);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .meta-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .meta-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #020613;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(58, 169, 255, 0.3);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.04);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .section {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-bottom: 30px;
      overflow: hidden;
    }

    .section-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 20px;
      margin: 0;
    }

    .section-body {
      padding: 20px;
    }

    /* Events Section */
    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .event-card {
      background: linear-gradient(145deg, #050816, #0e1430);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 20px;
      transition: all 0.2s ease;
    }

    .event-card:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(58, 169, 255, 0.1);
    }

    .event-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .event-detail {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .event-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      margin: 12px 0;
    }

    .event-button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #020613;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s ease;
    }

    .event-button:hover {
      transform: translateY(-2px);
    }

    .event-button:disabled {
      background: var(--muted);
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Bracket Section */
    .bracket-container {
      overflow-x: auto;
      padding: 20px 0;
    }

    .bracket {
      display: inline-flex;
      gap: 30px;
      min-width: 100%;
      padding: 0 20px;
    }

    .bracket-round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      min-width: 200px;
    }

    .bracket-round-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 15px;
    }

    .match {
      background: linear-gradient(145deg, #050816, #0e1430);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 12px;
      margin-bottom: 15px;
      min-height: 100px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .match:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(58, 169, 255, 0.1);
    }

    .match-id {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .match-player {
      font-size: 12px;
      padding: 6px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 4px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-player.winner {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      font-weight: 600;
      color: var(--success);
    }

    .match-time {
      font-size: 10px;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
    }

    /* ‚úÖ MOBILE FRIENDLY FIXTURES */
    @media (max-width: 768px) {
      .bracket-container {
        padding: 10px !important;
      }
      
      .bracket {
        flex-direction: column !important;
        gap: 20px !important;
      }
      
      .bracket-round {
        min-width: 100% !important;
        max-width: 100% !important;
      }
      
      .match {
        min-height: 80px !important;
        padding: 10px !important;
      }
      
      .match-player {
        font-size: 14px !important;
      }
      
      .match-id {
        font-size: 10px !important;
      }
    }

    .match-edit-btn {
      width: 100%;
      padding: 6px;
      margin-top: 8px;
      font-size: 11px;
      background: rgba(58, 169, 255, 0.2);
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .match-edit-btn:hover {
      background: rgba(58, 169, 255, 0.3);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--muted);
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(4, 9, 23, 0.95);
      color: var(--text);
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(58, 169, 255, 0.2);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .info-alert {
      background: rgba(58, 169, 255, 0.1);
      border-left: 3px solid var(--accent);
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 15px;
      color: var(--text);
    }

    .error-alert {
      background: rgba(255, 107, 107, 0.1);
      border-left: 3px solid var(--danger);
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 15px;
      color: var(--danger);
    }

    .success-alert {
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid var(--success);
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 15px;
      color: var(--success);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-state p {
      font-size: 14px;
      margin-bottom: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .header {
        grid-template-columns: 1fr;
      }

      .events-grid {
        grid-template-columns: 1fr;
      }

      .bracket {
        flex-wrap: wrap;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="tournaments.html">‚Üê Back</a>
    <div>
      <a href="tournaments.html">All Tournaments</a>
      <a href="admin.html">Admin</a>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Header Section -->
    <div class="header">
      <!-- Poster -->
      <div class="poster-section">
        <div class="poster-img" id="poster-container">
          <span>Tournament Poster</span>
        </div>
      </div>

      <!-- Tournament Info -->
      <div class="tournament-info">
        <div class="status-badge" id="status-badge">UPCOMING</div>
        <h1 id="tournament-name">Loading...</h1>

        <p><strong>üìç Venue:</strong> <span id="tournament-venue">-</span></p>
        <p><strong>üìÖ Dates:</strong> <span id="tournament-dates">-</span></p>
        <p><strong>‚è∞ Times:</strong> <span id="tournament-times">-</span></p>
        <p><strong>üéØ Capacity:</strong> <span id="tournament-capacity">-</span> players</p>
        <p><strong>üí∞ Base Price:</strong> ‚Çπ<span id="tournament-price">-</span></p>

        <div class="tournament-meta">
          <div class="meta-item">
            <div class="meta-label">Status</div>
            <div class="meta-value" id="entry-status">Accepting</div>
          </div>

        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" id="join-btn" onclick="openJoinModal()">
            Join Tournament
          </button>
          <button class="btn btn-secondary" id="admin-edit-btn" onclick="openAdminPanel()" style="display: none;">
            Admin: Manage
          </button>
        </div>
      </div>
    </div>

    <!-- Events Section -->
    <div class="section" id="events-section" style="display: none;">
      <div class="section-header">
        <h2>üìã Available Events</h2>
      </div>
      <div class="section-body">
        <div class="events-grid" id="events-grid">
          <!-- Events loaded here -->
        </div>
      </div>
    </div>

    <!-- Bracket Section -->
    <div class="section" id="bracket-section" style="display: none;">
      <div class="section-header">
        <h2>üè∏ Tournament Bracket</h2>
      </div>
      <div class="section-body">
        <div class="bracket-container">
          <div class="bracket" id="bracket-display">
            <!-- Bracket rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Join Tournament Modal -->
  <!-- Join Tournament Modal -->
<!-- Join Tournament Modal (SIMPLE VERSION) -->
<div id="join-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Join Tournament</h2>
      <button class="modal-close" onclick="closeJoinModal()">&times;</button>
    </div>
    <div id="join-error-alert" class="error-alert" style="display: none;"></div>
    
    <!-- NEW: PROMINENT Category Selector -->
    <div class="form-group" style="background: rgba(58, 169, 255, 0.1); border-left: 3px solid var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
      <label style="font-weight: 600; color: var(--accent);">üéØ Select Your Category</label>
      <select id="join-category-select" style="margin-top: 8px;">
        <option value="">-- Choose Category First --</option>
      </select>
      <div id="category-preview" style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.2); border-radius: 6px; font-size: 13px; display: none;"></div>
    </div>
    
    <form onsubmit="submitJoinForm(event)">
      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="join-name" required>
      </div>
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="join-email" required>
      </div>
      <div class="form-group">
        <label>Phone Number *</label>
        <input type="tel" id="join-phone" required>
      </div>
      <div class="form-group">
        <label>Academy/Club *</label>
        <input type="text" id="join-academy" required>
      </div>
      <div class="form-group">
        <label>Partner Name (for doubles)</label>
        <input type="text" id="join-partner">
      </div>
      <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;" disabled id="submit-btn">Submit Entry</button>
    </form>
  </div>
</div>

  <!-- Match Editor Modal -->
  <div id="match-editor-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Match</h2>
        <button class="modal-close" onclick="closeMatchEditor()">√ó</button>
      </div>

      <div class="info-alert">
        Match: <strong id="match-info-text">M1</strong> in <strong id="round-info-text">Final</strong>
      </div>

      <form onsubmit="submitMatchEdit(event)">
        <div class="form-row">
          <div class="form-group">
            <label>Player A Name</label>
            <input type="text" id="edit-player1-name" readonly />
          </div>
          <div class="form-group">
            <label>Player A Academy</label>
            <input type="text" id="edit-player1-academy" readonly />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Player B Name</label>
            <input type="text" id="edit-player2-name" readonly />
          </div>
          <div class="form-group">
            <label>Player B Academy</label>
            <input type="text" id="edit-player2-academy" readonly />
          </div>
        </div>

        <div class="form-group">
          <label>Match Date & Time</label>
          <input type="datetime-local" id="edit-match-time" />
        </div>

        <div class="form-group">
          <label>Match Status</label>
          <select id="edit-match-status">
            <option value="pending">Pending</option>
            <option value="live">Live</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div class="form-group" id="winner-group" style="display: none;">
          <label>Match Winner</label>
          <select id="edit-match-winner">
            <option value="0">No winner</option>
            <option value="1">Player A wins</option>
            <option value="2">Player B wins</option>
          </select>
        </div>

        <div class="info-alert" id="advance-note" style="display: none;">
          üí° After setting winner, click "Save & Advance" to move winner to next round.
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
          Save Changes
        </button>
      </form>
    </div>
  </div>

  <script src="js/db.js"></script>
  <script>
    const API_URL = "http://127.0.0.1:5000/api/";
    let currentTournament = null;
    let currentEvents = [];  // ‚Üê ADD THIS LINE
    let currentBracket = null;
    let isAdmin = false;

    // Get tournament ID from URL
    function getTournamentIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // Load tournament details
    function loadTournamentDetails() {
      const tournamentId = getTournamentIdFromUrl();
      if (!tournamentId) {
        document.querySelector(".container").innerHTML =
          '<p style="text-align: center; color: #999;">Tournament not found</p>';
        return;
      }

      fetch(`${API_URL}/tournaments/${tournamentId}`)
        .then((r) => r.json())
        .then((data) => {
          currentTournament = data;
          renderTournamentDetails();
          checkIfAdmin();
          loadEvents();
          loadBracket();
        })
        .catch((err) => console.error("Error loading tournament:", err));
    }

    // Render tournament details
    function renderTournamentDetails() {
      const t = currentTournament;

      // Status badge
      const statusBadge = document.getElementById('status-badge');
      statusBadge.textContent = (t.status || 'scheduled').toUpperCase();
      statusBadge.className = 'status-badge status-' + (t.status || 'scheduled').toLowerCase();
      if (t.acceptentries) statusBadge.classList.add("status-upcoming");
      else statusBadge.classList.add("status-ongoing");

      // Basic info
      document.getElementById("tournament-name").textContent = t.name;
      document.getElementById("tournament-venue").textContent = t.venue;
      document.getElementById("tournament-price").textContent = t.price;
      document.getElementById("tournament-capacity").textContent = t.capacity;

      // Dates and times
      const startDate = new Date(t.startdate).toLocaleDateString("en-IN");
      const endDate = new Date(t.enddate).toLocaleDateString("en-IN");
      document.getElementById("tournament-dates").textContent = `${startDate} to ${endDate}`;

      const startTime = new Date(`${t.startdate} ${t.starttime}`).toLocaleTimeString("en-IN", {
        hour: "2-digit",
        minute: "2-digit",
      });
      const endTime = new Date(`${t.enddate} ${t.endtime}`).toLocaleTimeString("en-IN", {
        hour: "2-digit",
        minute: "2-digit",
      });
      document.getElementById("tournament-times").textContent = `${startTime} - ${endTime}`;

      // Entry status
      document.getElementById("entry-status").textContent = t.acceptentries ? "üü¢ Accepting" : "üî¥ Closed";

      // Poster
      if (t.posterurl) {
        document.getElementById("poster-container").innerHTML = `<img src="${t.posterurl}" alt="Poster" />`;
      }

      // Join button visibility
      const joinBtn = document.getElementById("join-btn");
      if (t.acceptentries && t.status !== "completed") {
        joinBtn.style.display = "block";
      } else {
        joinBtn.style.display = "none";
      }
    }


    // Check if user is admin
    function checkIfAdmin() {
      const token = localStorage.getItem("authToken");
      const adminEmail = localStorage.getItem("adminEmail");
      if (token && adminEmail === "admin@flylight.com") {
        isAdmin = true;
        document.getElementById("admin-edit-btn").style.display = "block";
        document.getElementById("admin-bracket-btn").style.display = "none";
      }
    }

    // Load events for this tournament - ERROR SAFE
    function loadEvents() {
      fetch(`${API_URL}/tournaments/${currentTournament.id}/events`)
        .then((r) => r.json())
        .then((response) => {
          // Check if response is an error
          if (response.error) {
            console.error("Events API error:", response.error);
            document.getElementById("events-section").style.display = "none";
            return;
          }

          // Ensure it's an array
          const events = Array.isArray(response) ? response : [];
          currentEvents = events;  // ‚Üê ADD THIS LINE (stores events globally)
          
          const eventsSection = document.getElementById("events-section");
          const eventsGrid = document.getElementById("events-grid");
          
          if (!currentTournament.accept_entries) {
            // ‚úÖ CLOSED: Hide events, fixtures will show instead
            document.getElementById('events-section').style.display = 'none';
            return;
          }

          // Show events section
          eventsSection.style.display = "block";
          eventsGrid.innerHTML = "";

          events.forEach((event) => {
            const spotsLeft = event.max_participants - event.current_participants;
            const isFull = event.current_participants >= event.max_participants;

            const eventCard = document.createElement("div");
            eventCard.className = "event-card";
            eventCard.innerHTML = `
              <div class="event-name">${escapeHtml(event.name || 'Unnamed Event')}</div>
              <div class="event-detail">
                <span style="color: ${event.category ? 'var(--accent)' : 'var(--muted)'}">
                  ${event.category || 'General'}
                </span> ‚Ä¢ 
                ${isFull ? '‚ùå FULL' : `‚úì ${spotsLeft} spots left`}
              </div>
              <div class="event-detail">üë• ${event.current_participants || 0}/${event.max_participants || 32}</div>
              <div class="event-price">‚Çπ${event.entry_fee || 0}</div>
              ${event.description ? `
                <div class="event-detail" style="font-size: 12px; margin-top: 8px;">
                  ${escapeHtml(event.description.substring(0, 80))}${event.description.length > 80 ? '...' : ''}
                </div>
              ` : ''}
              <button class="event-button" 
                      onclick="selectEvent('${event.id}')"
                      ${isFull || !currentTournament.accept_entries ? 'disabled' : ''}
                      style="${isFull ? 'background: var(--muted); cursor: not-allowed;' : ''}">
                ${isFull ? 'FULL' : currentTournament.accept_entries ? 'Join This Event' : 'Closed'}
              </button>
            `;
            eventsGrid.appendChild(eventCard);
          });

          // Populate join modal dropdown
          populateJoinModalEvents(events);
        })
        .catch((err) => {
          console.error("Error loading events:", err);
          document.getElementById("events-section").style.display = "none";
        });
    }


    function populateJoinModalEvents(events) {
      const eventSelect = document.getElementById("join-event");
      if (!eventSelect) return;
      
      eventSelect.innerHTML = '<option value="">-- Select Category (Optional) --</option>';
      
      events.forEach((event) => {
        const isFull = event.current_participants >= event.max_participants;
        const option = document.createElement("option");
        option.value = event.id;
        option.disabled = isFull;
        option.textContent = `${event.name} (${event.category || 'General'}) - ‚Çπ${event.entry_fee} ${isFull ? '[FULL]' : ''}`;
        eventSelect.parentElement.parentElement.style.display = events.length > 0 ? 'block' : 'none';
        eventSelect.appendChild(option);
      });
    }


    // Load bracket
    function loadBracket() {
    if (!currentTournament.bracket_data) return;

    // ‚úÖ Always show bracket if it exists (no more accept_entries check)
    try {
      const bracketData = typeof currentTournament.bracket_data === 'string'
        ? JSON.parse(currentTournament.bracket_data)
        : currentTournament.bracket_data;

      if (!bracketData || !Array.isArray(bracketData) || bracketData.length === 0) {
        return;
      }

      document.getElementById('bracket-section').style.display = 'block';
      currentBracket = bracketData;
      renderBracket();
    } catch (e) {
      console.error('Error parsing bracket:', e);
    }
  }



    function selectEvent(eventId) {
      const select = document.getElementById('join-category-select'); // or 'modal-category-select' if that's what you used

      if (!select) {
        console.warn('join-category-select not found; opening modal without preselect');
        openJoinModal();
        return;
      }

      // Preselect the clicked event if it exists in the dropdown
      select.value = eventId;
      if (select.onchange) {
        select.onchange();  // trigger preview update if you added one
      }

      openJoinModal();
    }


    // Render bracket
   function renderBracket() {
  // ‚úÖ FIX: Use correct field name from backend
  const bracketData = typeof currentTournament.bracket_data === 'string' 
    ? JSON.parse(currentTournament.bracket_data)
    : currentTournament.bracket_data;

  if (!bracketData || !Array.isArray(bracketData) || bracketData.length === 0) {
    return;
  }

  currentBracket = bracketData; // Store for reference
  const bracketDisplay = document.getElementById("bracket-display");
  bracketDisplay.innerHTML = "";

  const roundNames = [
    "Final",
    "Semi-finals", 
    "Quarter-finals",
    "Round of 16",
    "Round of 32",
    "Round of 64",
  ];

  currentBracket.forEach((roundMatches, roundIndex) => {
    const roundColumn = document.createElement("div");
    roundColumn.className = "bracket-round";

    const roundTitle = document.createElement("div");
    roundTitle.className = "bracket-round-title";
    const reversedIndex = currentBracket.length - 1 - roundIndex;
    roundTitle.textContent = roundNames[reversedIndex] || `Round ${reversedIndex + 1}`;
    roundColumn.appendChild(roundTitle);

    roundMatches.forEach((match) => {
      const matchEl = document.createElement("div");
      matchEl.className = "match";  // ‚úÖ READ-ONLY - NO onclick
      
      // Match ID
      const matchId = document.createElement("div");
      matchId.className = "match-id";
      matchId.textContent = match.id;
      matchEl.appendChild(matchId);

      // Player 1 ‚úÖ READ-ONLY
      const p1El = document.createElement("div");
      p1El.className = "match-player";
      if (match.winner === 1) p1El.classList.add("winner");
      p1El.innerHTML = `<span>${match.player1?.name || "‚Äî"}</span>`;
      matchEl.appendChild(p1El);

      // Player 2 ‚úÖ READ-ONLY  
      const p2El = document.createElement("div");
      p2El.className = "match-player";
      if (match.winner === 2) p2El.classList.add("winner");
      p2El.innerHTML = `<span>${match.player2?.name || "‚Äî"}</span>`;
      matchEl.appendChild(p2El);

      // Time
      if (match.time) {
        const timeEl = document.createElement("div");
        timeEl.className = "match-time";
        timeEl.textContent = new Date(match.time).toLocaleString("en-IN", {
          month: "short",
          day: "numeric", 
          hour: "2-digit",
          minute: "2-digit",
        });
        matchEl.appendChild(timeEl);
      }

      // ‚úÖ NO EDIT BUTTON - pure read-only for users
      roundColumn.appendChild(matchEl);
    });

    bracketDisplay.appendChild(roundColumn);
  });
}


    // Join modal functions
      function openJoinModal() {
        if (!currentTournament) {
          alert('Tournament not loaded yet');
          return;
        }
        
        populateModalCategories();  // Uses existing currentEvents
        document.getElementById('join-modal').classList.add('active');
      }

      // NEW: Populate categories using EXISTING events data
      function populateModalCategories() {
        const select = document.getElementById('join-category-select');
        const preview = document.getElementById('category-preview');
        const submitBtn = document.getElementById('submit-btn');
        
        if (currentEvents.length === 0) {
          select.innerHTML = '<option value="">No categories available</option>';
          return;
        }
        
        select.innerHTML = '<option value="">-- Choose Category --</option>';
        
        currentEvents.forEach(event => {
          // backend fields are snake_case
          const current = event.current_participants || 0;
          const max = event.max_participants || 32;
          const fee = event.entry_fee || 0;

          const isFull = current >= max;

          const option = document.createElement('option');
          option.value = event.id;
          option.disabled = isFull || !currentTournament.accept_entries;

          const categoryName = event.category || 'General';
          option.textContent = `${event.name} (${categoryName}) - ‚Çπ${fee}`;
          if (isFull) option.textContent += ' [FULL]';

          select.appendChild(option);
        });

        
        // Preview on change
        select.onchange = function() {
          if (this.value) {
            const event = currentEvents.find(e => e.id == this.value);
            const spotsLeft = event.maxparticipants - event.currentparticipants;
            preview.innerHTML = `
              ‚úÖ <strong>${event.name}</strong> (${event.category || 'General'})<br>
              üí∞ Entry: ‚Çπ${event.entryfee} | üìç Spots: ${spotsLeft > 0 ? spotsLeft : 'FULL'}
            `;
            preview.style.display = 'block';
            submitBtn.disabled = false;
          } else {
            preview.style.display = 'none';
            submitBtn.disabled = true;
          }
        };
      }

    // NEW FUNCTION: Populate category dropdown inside modal
    function populateCategorySelector() {
      const select = document.getElementById('modal-category-select');
      const previewCard = document.getElementById('category-preview-card');
      const categoryGroup = document.getElementById('modal-category-group');
      
      // Show loading state
      select.innerHTML = '<option value="">Loading categories...</option>';
      
      fetch(API_URL + 'tournaments/' + currentTournament.id + '/events')
        .then(r => {
          if (!r.ok) throw new Error('Events API failed');
          return r.json();
        })
        .then(events => {
          if (!Array.isArray(events)) {
            events = [];
          }
          
          if (events.length === 0) {
            select.innerHTML = '<option value="">No categories available</option>';
            categoryGroup.style.display = 'block';
            return;
          }
          
          // Clear and rebuild dropdown
          select.innerHTML = '<option value="">-- Choose a Category --</option>';
          
          events.forEach(event => {
            const isFull = event.currentparticipants >= event.maxparticipants;
            const option = document.createElement('option');
            option.value = event.id;
            option.disabled = isFull;
            
            const categoryName = event.category || 'General';
            option.textContent = `${event.name || 'Event'} (${categoryName}) - ‚Çπ${event.entryfee || 0}${isFull ? ' - FULL' : ''}`;
            option.dataset.eventData = JSON.stringify(event);
            
            select.appendChild(option);
            // Add this temporarily in populateCategorySelector()
            console.log('Events loaded:', events);

          });
          
          // Add change listener
          // Preview on change
          select.onchange = function() {
            if (this.value) {
              const event = currentEvents.find(e => e.id == this.value);
              const current = event.current_participants || 0;
              const max = event.max_participants || 32;
              const fee = event.entry_fee || 0;
              const spotsLeft = max - current;

              preview.innerHTML = `
                ‚úÖ <strong>${event.name}</strong> (${event.category || 'General'})<br>
                üí∞ Entry: ‚Çπ${fee} | üìç Spots: ${spotsLeft > 0 ? spotsLeft : 'FULL'}
              `;
              preview.style.display = 'block';
              submitBtn.disabled = false;
            } else {
              preview.style.display = 'none';
              submitBtn.disabled = true;
            }
          };

          
          categoryGroup.style.display = 'block';
        })
        .catch(err => {
          console.error('Error loading categories:', err);
          select.innerHTML = '<option value="">Error loading categories</option>';
          categoryGroup.style.display = 'block';
        });
    }


    // NEW FUNCTION: Display category details preview card
    function showCategoryPreview(eventData) {
      const previewCard = document.getElementById('category-preview-card');
      const categoryName = eventData.category ? eventData.category : 'General';
      const spotsLeft = eventData.maxparticipants - eventData.currentparticipants;
      const isFull = spotsLeft <= 0;
      
      // Update preview card content
      document.getElementById('preview-category-name').innerHTML = 
        `<strong>Category:</strong> ${escapeHtml(eventData.name)}`;
      
      document.getElementById('preview-category-type').innerHTML = 
        `<strong>Type:</strong> ${escapeHtml(categoryName)}`;
      
      document.getElementById('preview-category-fee').innerHTML = 
        `<strong>Entry Fee:</strong> ‚Çπ${eventData.entryfee}`;
      
      const spotsText = isFull 
        ? `<span style="color: var(--danger);">‚ùå FULL - No spots available</span>` 
        : `<span style="color: var(--success);">‚úì ${spotsLeft} spots available</span>`;
      
      document.getElementById('preview-category-spots').innerHTML = spotsText;
      
      // Show preview card
      previewCard.style.display = 'block';
      
      // Store selected event ID for form submission
      document.getElementById('modal-category-select').dataset.selectedEventId = eventData.id;
    }


    function closeJoinModal() {
      document.getElementById("join-modal").classList.remove("active");
      document.getElementById("join-error-alert").style.display = "none";
    }

    function selectEventToJoin(eventId, eventName, price) {
      openJoinModal();
      document.getElementById("join-event").value = eventId;
      document.getElementById("event-select-group").style.display = "block";
    }

    function submitJoinForm(e) {
      e.preventDefault();
      
      const categoryId = document.getElementById('join-category-select').value;
      if (!categoryId) {
        document.getElementById('join-error-alert').style.display = 'block';
        document.getElementById('join-error-alert').textContent = 'Please select a category first';
        return;
      }
      
      if (!currentTournament.accept_entries) {
        document.getElementById('join-error-alert').style.display = 'block';
        document.getElementById('join-error-alert').textContent = 'Tournament not accepting entries';
        return;
      }

      
      const name = document.getElementById('join-name').value;
      const email = document.getElementById('join-email').value;
      const phone = document.getElementById('join-phone').value;
      const academy = document.getElementById('join-academy').value;
      
      fetch(API_URL + 'tournaments/' + currentTournament.id + '/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          email,
          phone,
          academy_name: academy,      // match backend field
          selected_event_id: categoryId // match backend field
        })
      })

      .then(r => r.json())
      .then(data => {
        if (data.error) {
          document.getElementById('join-error-alert').style.display = 'block';
          document.getElementById('join-error-alert').textContent = data.error;
        } else {
          alert('‚úÖ Successfully joined ' + categoryId + '!');
          closeJoinModal();
          loadPlayerCount();
        }
      })
      .catch(err => {
        document.getElementById('join-error-alert').style.display = 'block';
        document.getElementById('join-error-alert').textContent = 'Error joining tournament';
        console.error(err);
      });
    }


    // Match editor functions
    let currentMatchEdit = null;

    function openMatchEditor(match) {
      if (!currentTournament) {
        alert('No tournament selected');
        return;
      }

      currentMatchEdit = match;

      // Populate fields
      document.getElementById('match-info-text').textContent = match.id;
      document.getElementById('round-info-text').textContent = match.roundIndex + 1;
      
      document.getElementById('edit-player1-name').value = match.player1?.name || '';
      document.getElementById('edit-player1-academy').value = match.player1?.academy || '';
      document.getElementById('edit-player2-name').value = match.player2?.name || '';
      document.getElementById('edit-player2-academy').value = match.player2?.academy || '';
      
      document.getElementById('edit-match-time').value = match.time || '';
      document.getElementById('edit-match-status').value = match.status || 'pending';
      document.getElementById('edit-match-winner').value = match.winner || '0';

      // Show/hide winner based on status
      toggleWinnerGroup();

      // Open modal
      document.getElementById('match-editor-modal').classList.add('active');
    }

    function toggleWinnerGroup() {
      const status = document.getElementById('edit-match-status').value;
      const winnerGroup = document.getElementById('winner-group');
      const advanceNote = document.getElementById('advance-note');

      if (status === 'completed') {
        winnerGroup.style.display = 'block';
        advanceNote.style.display = 'block';
      } else {
        winnerGroup.style.display = 'none';
        advanceNote.style.display = 'none';
      }
    }

    function closeMatchEditor() {
      document.getElementById('match-editor-modal').classList.remove('active');
      currentMatchEdit = null;
    }

    async function submitMatchEdit(event) {
      event.preventDefault();

      if (!currentMatchEdit) {
        alert('No match selected');
        return;
      }

      // Update match from form
      currentMatchEdit.player1.name = document.getElementById('edit-player1-name').value;
      currentMatchEdit.player1.academy = document.getElementById('edit-player1-academy').value;
      currentMatchEdit.player2.name = document.getElementById('edit-player2-name').value;
      currentMatchEdit.player2.academy = document.getElementById('edit-player2-academy').value;
      currentMatchEdit.time = document.getElementById('edit-match-time').value || null;
      currentMatchEdit.status = document.getElementById('edit-match-status').value;
      currentMatchEdit.winner = parseInt(document.getElementById('edit-match-winner').value) || 0;

      // If winner set and completed, advance to next round
      if (currentMatchEdit.winner !== 0 && currentMatchEdit.status === 'completed') {
        advanceWinner(currentMatchEdit);
      }

      // Re-render
      renderFixtures();
      closeMatchEditor();

      // Auto-save to DB
      saveBracketToDatabase();
    }

    function advanceWinner(match) {
      const roundIndex = match.roundIndex;
      if (roundIndex >= fixtures.length - 1) {
        alert('üèÜ Tournament Final Complete!');
        return;
      }

      const winner = match.winner === 1 ? match.player1 : match.player2;
      const nextRound = fixtures[roundIndex + 1];
      const nextMatchIndex = Math.floor(match.matchIndex / 2);
      const slot = match.matchIndex % 2;

      if (nextMatchIndex < nextRound.length) {
        const nextMatch = nextRound[nextMatchIndex];
        if (slot === 0) {
          nextMatch.player1 = { ...winner };
        } else {
          nextMatch.player2 = { ...winner };
        }
      }
    }

    // Admin functions
    function openAdminPanel() {
      window.location.href = `admin-fix.html?id=${currentTournament.id}`;
    }

    function openBracketAdmin() {
      window.location.href = `admin-fix.html?id=${currentTournament.id}`;
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", loadTournamentDetails);

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Auto-refresh tournament status every 10 seconds to catch admin changes
    setInterval(async () => {
      if (currentTournament) {
        const updated = await checkTournamentStatus(currentTournament.id);
        if (updated && updated.accept_entries !== currentTournament.accept_entries) {
          currentTournament = updated;
          renderTournamentDetails();
          loadBracket(); // Re-check if bracket should show
        }
      }
    }, 10000);


  </script>
</body>
</html>
